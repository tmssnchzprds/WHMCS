var Vmbox_Scripts=null;function Set_Vmbox_Scripts(e){if(e&&(e.length||0===e.length)){var t=null===Vmbox_Scripts||e.length!==Vmbox_Scripts.length;if(!t)for(var a=0;a<e.length&&!t;a++)(e[a].Name!==Vmbox_Scripts[a].Name||e[a].LogoBase64&&!Vmbox_Scripts[a].LogoBase64||!e[a].LogoBase64&&Vmbox_Scripts[a].LogoBase64||e[a].LogoBase64.length!==Vmbox_Scripts[a].LogoBase64.length)&&(t=!0),(e[a].LastRun&&!Vmbox_Scripts[a].LastRun||!e[a].LastRun&&Vmbox_Scripts[a].LastRun||e[a].LastRun&&Vmbox_Scripts[a].LastRun&&(e[a].LastRun.Done!==Vmbox_Scripts[a].LastRun.Done||e[a].LastRun.Failed!==Vmbox_Scripts[a].LastRun.Failed||e[a].LastRun.Canceled!==Vmbox_Scripts[a].LastRun.Canceled))&&(t=!0);Vmbox_Scripts=e.length?e:[],t&&BuildScriptElements()}}function BuildScriptElements(){var e=document.getElementById("ScriptsList");if(e){e.innerHTML="";for(var t=0;t<Vmbox_Scripts.length;t++){var a=CreateScriptElement(t);e.appendChild(a)}0===Vmbox_Scripts.length?(document.getElementById("ScriptsTabButton").style.display="none",e.innerHTML=i18n.Translate("No Scripts available right now!")):document.getElementById("ScriptsTabButton").style.display="unset"}else console.log("script list not found")}function CreateScriptElement(e){var t=Vmbox_Scripts[e];if(t){var a=CreateElement("div",{id:`ScriptElem_${t.ScriptId}`,classList:["script"],onclick:OpenScriptModal(e)});t.LastRun&&(t.LastRun.Done?t.LastRun.Failed?a.classList.add("failed"):t.LastRun.Canceled?a.classList.add("canceled"):a.classList.add("done"):a.classList.add("active"));var n=t.LogoBase64;n.length>10&&!n.startsWith("data:image/png;base64,")&&(n=`data:image/png;base64,${n}`);var i=CreateElement("img",{src:n});a.appendChild(i);var r=CreateElement("div",{innerHTML:t.Name,classList:["scriptTitle"]});return a.appendChild(r),a}}function OpenScriptModal(e){return()=>{var t=Vmbox_Scripts[e];if(t){var a,n=CreateElement("div",{classList:["scriptModalContent"]}),i=CreateElement("div",{classList:["scriptDesc"],innerHTML:t.Desc}),r=CreateElement("div",{classList:["tab","i18n"]}),s=CreateElement("button",{classList:["tablinks","i18n"],onclick:e=>OpenScriptModalTab(n,"RunTab",e),innerHTML:"Run"});r.appendChild(s);var l=CreateElement("button",{id:`ScriptDetailsBtn_${t.ScriptId}`,classList:["tablinks","i18n",t.LastRun?"-":"d-none"],onclick:e=>{makeScriptModalWide(),e.target.classList.remove("d-none"),OpenScriptModalTab(n,"DetailsTab",e)},innerHTML:"Details"});r.appendChild(l);var d=CreateElement("button",{id:`ScriptStdOutBtn_${t.ScriptId}`,classList:["tablinks","i18n",t.LastRun&&""!==t.LastRun.STDOUT?"-":"d-none"],onclick:e=>{makeScriptModalWide(),e.target.classList.remove("d-none"),OpenScriptModalTab(n,"StdOutTab",e)},innerHTML:"Output"});r.appendChild(d);var c=CreateElement("button",{id:`ScriptStdErrBtn_${t.ScriptId}`,classList:["tablinks","i18n",t.LastRun&&""!==t.LastRun.STDERR?"-":"d-none"],onclick:e=>{makeScriptModalWide(),e.target.classList.remove("d-none"),OpenScriptModalTab(n,"StdErrTab",e)},innerHTML:"Error"});r.appendChild(c),a=t.LastRun?l:s;var o=CreateElement("div",{id:"RunTab",classList:["tabcontent"]}),p=CreateRunTabParams(t);o.appendChild(p);var u=CreateElement("div",{id:"DetailsTab",classList:["tabcontent"]}),m=t.Name;t.LastRun&&(t.LastRun.detailsContent||generateCallbacksString(e),m=t.LastRun.detailsContent);m=CreateElement("textarea",{id:`detailsContent_${t.ScriptId}`,classList:["textContent"],innerHTML:m});u.appendChild(m);var S=CreateElement("div",{id:`CancelScript_${t.ScriptId}`,classList:["d-flex","justify-content-end"]}),L=CreateElement("button",{classList:["borderedBtn","i18n"],onclick:()=>{t.LastRun&&CancelScript(t.LastRun.ExecId)},innerHTML:"Cancel Execution!"});L.style.padding="10px",S.appendChild(L),u.appendChild(S),t.LastRun&&!t.LastRun.Done?S.classList.remove("d-none"):S.classList.add("d-none");var v=CreateElement("div",{id:"StdOutTab",classList:["tabcontent"]}),C=t.Name;t.LastRun&&(C=t.LastRun.STDOUT);C=CreateElement("textarea",{id:`stdOutContent_${t.ScriptId}`,classList:["textContent"],innerHTML:C});v.appendChild(C);var b=CreateElement("div",{id:"StdErrTab",classList:["tabcontent"]}),f=t.Name;t.LastRun&&(t.LastRun.detailsContent||(f=t.LastRun.STDERR));f=CreateElement("textarea",{id:`stdErrContent_${t.ScriptId}`,classList:["textContent"],innerHTML:f});b.appendChild(f),n.appendChild(i),n.appendChild(r),n.appendChild(o),n.appendChild(u),n.appendChild(v),n.appendChild(b),OpenModal(t.Name,n,"scriptModal",t.LogoBase64),window.i18n&&window.i18n.TranslateAllDocument(),a&&a.click()}}}function OpenScriptModalTab(e,t,a){var n,i,r;for(i=e.querySelectorAll(".tabcontent"),n=0;n<i.length;n++)i[n].style.display="none";for(r=e.querySelectorAll(".tablinks"),n=0;n<r.length;n++)r[n].className=r[n].className.replace(" active","");e.querySelector(`#${t}`).style.display="block",a&&(a.currentTarget.className+=" active")}function CreateRunTabParams(e){for(var t=e.Params,a=CreateElement("div",{id:`ParamContent_${e.ScriptId}`,classList:["paramContent"]}),n=0;n<t.length;n++){var i,r=CreateElement("div",{classList:["param"]}),s=CreateElement("label",{for:`ParamInp_${t[n].Name}`,innerHTML:`${t[n].Title}`});switch(t[n].Type){case"string":i=CreateElement("input",{id:`ParamInp_${t[n].Name}`,type:"text",defaultValue:t[n].Default,placeholder:`${t[n].Desc}`});break;case"number":i=CreateElement("input",{id:`ParamInp_${t[n].Name}`,type:"number",defaultValue:t[n].Default,placeholder:`${t[n].Desc}`});break;case"pass":s.innerHTML=s.innerHTML+(t[n].Desc&&""!==t[n].Desc?` (${t[n].Desc})`:""),i=CreateElement("input",{id:`ParamInp_${t[n].Name}`,type:"password",defaultValue:t[n].Default});break;case"passWithConfirm":s.innerHTML=s.innerHTML+(t[n].Desc&&""!==t[n].Desc?` (${t[n].Desc})`:""),i=CreateElement("div",{});var l=CreateElement("input",{id:`ParamInp_${t[n].Name}`,type:"password"}),d=CreateElement("label",{for:`ParamInp_${t[n].Name}_2`,innerHTML:"Repeat Password"}),c=CreateElement("input",{id:`ParamInp_${t[n].Name}_2`,type:"password"});i.appendChild(l),i.appendChild(d),i.appendChild(c);break;case"bool":(i=CreateElement("div",{innerHTML:`<span>${t[n].Desc}</span>`,classList:["d-flex","justify-content-between"]})).style.paddingTop="5px";var o=CreateElement("label",{classList:["paramSwitch"]}),p=CreateElement("input",{id:`ParamInp_${t[n].Name}`,type:"checkbox",defaultChecked:t[n].Default});o.appendChild(p),o.appendChild(CreateElement("div",{})),i.appendChild(o);break;case"select":i=CreateElement("label",{for:`ParamInp_${t[n].Name}`,classList:["paramSelect"]});var u=CreateElement("select",{id:`ParamInp_${t[n].Name}`,defaultValue:t[n].Default,innerHTML:`${t[n].Desc&&""!==t[n].Desc?`<optgroup><option disabled value="_description">${t[n].Desc}</option></optgroup>`:""}${t[n].SelectOptions}`});i.appendChild(u),i.appendChild(CreateElement("svg",{innerHTML:'<use xlink:href="#select-arrow-down"></use>'})),i.appendChild(CreateElement("svg",{classList:["vmb_sprites"],innerHTML:'<symbol id="select-arrow-down" viewbox="0 0 10 6"><polyline points="1 1 5 5 9 1"></polyline></symbol>'}));break;case"file":i=CreateElement("div",{});var m=CreateElement("input",{id:`ParamInp_${t[n].Name}`,type:"file",placeholder:`${t[n].Desc}`});t[n].FileType&&""!==t[n].FileType&&(m.accept=`${t[n].FileType}`),m.style.fontSize=".8rem",m.style.padding="1px",m.onchange=(e=>t=>{window.paramFiles={};var a=t.target.files[0];if(e.MaxFileSize&&e.MaxFileSize>0){var n=1024*e.MaxFileSize;if("MB"===e.MaxFileSizeUnit&&(n*=1024),a.size>n)return void alert(`Selected file must be smaller than ${e.MaxFileSize} ${e.MaxFileSizeUnit}`)}var i=new FileReader;i.onloadend=(()=>{var t=ConvertArrayBufferToBase64(i.result);window.paramFiles[e.Name]=t}),i.readAsArrayBuffer(a)})(t[n]),i.appendChild(m),i.appendChild(CreateElement("span",{innerHTML:`${t[n].Desc}`}))}r.appendChild(s),r.appendChild(i),a.appendChild(r),a.appendChild(CreateElement("span",{classList:["sep"]}))}var S=CreateElement("div",{classList:["d-flex","justify-content-center"]}),L=CreateElement("button",{classList:["borderedBtn","w-100"],innerHTML:"Run",onclick:t=>RunScript(e,t)});return L.style.maxWidth="150px",L.style.margin="auto",S.appendChild(L),a.appendChild(S),a}function RunScript(e,t){var a=document.querySelector(`#ParamContent_${e.ScriptId}`);if(a){var n=e.Params,i={};if(n)for(var r=0;r<n.length;r++){var s=n[r],l=a.querySelector(`#ParamInp_${s.Name}`);if(!l&&s.Required)return void alert(`${s.Title} is required`);switch(s.Type){case"string":if(""===l.value&&s.Required)return void alert(`${s.Title} is required`);i[s.Name]=`${l.value}`;break;case"number":if(""===l.value&&s.Required)return void alert(`${s.Title} is required`);var d=Number(l.value);if(isNaN(d))return void alert(`${s.Title} must be a number`);i[s.Name]=`${l.value}`;break;case"pass":if(""===l.value&&s.Required)return void alert(`${s.Title} is required`);i[s.Name]=`${l.value}`;break;case"passWithConfirm":var c=a.querySelector(`#ParamInp_${s.Name}_2`);if(""===l.value&&s.Required)return void alert(`${s.Title} is required`);if(!c||c.value!==l.value)return void alert("Repeat Password is not correct");i[s.Name]=`${l.value}`;break;case"bool":i[s.Name]=`${l.checked?"true":"false"}`;break;case"select":if(""===l.value&&s.Required)return void alert(`${s.Title} is required`);i[s.Name]=`${l.value}`;break;case"file":if(!l.files||l.files.length<1)return void alert(`${s.Title} is required`);if(!window.paramFiles||!window.paramFiles[s.Name])return void alert(`${s.Title} is required`);i[s.Name]=window.paramFiles[s.Name]}}ExecScript(e.ScriptId,i)}}function ExecScript(e,t){}function CancelScript(e){}function onExecScriptResult(e){if("success"===(e=JSON.parse(e)).Res){var t=document.querySelector(`#ScriptDetailsBtn_${e.ScriptId}`);t&&t.click&&t.click();var a=document.querySelector(`#ScriptStdOutBtn_${e.ScriptId}`);a&&a.classList.add("d-none");var n=document.querySelector(`#ScriptStdErrBtn_${e.ScriptId}`);n&&n.classList.add("d-none")}else console.log(e.Data)}function onExecScriptUpdate(e){if(Vmbox_Scripts)for(var t=0;t<Vmbox_Scripts.length;t++)if(Vmbox_Scripts[t].ScriptId===e.ScriptId)return Vmbox_Scripts[t].LastRun=e,void UpdateScriptExecDetails(t)}function UpdateScriptExecDetails(e){var t=Vmbox_Scripts[e];if(t){var a=document.querySelector(`#ScriptElem_${t.ScriptId}`);if(a){var n=document.querySelector(`#CancelScript_${t.ScriptId}`);t.LastRun.Done?(a.classList.remove("active"),a.classList.add(t.LastRun.Failed?"failed":t.LastRun.Canceled?"canceled":"done"),n&&n.classList.add("d-none")):(a.classList.add("active"),a.classList.remove("done"),a.classList.remove("failed"),a.classList.remove("canceled"),n&&n.classList.remove("d-none"));var i=generateCallbacksString(e),r=document.querySelector(`#detailsContent_${t.ScriptId}`);if(r){if(r.innerHTML=i,""!==t.LastRun.STDOUT){var s=document.querySelector(`#ScriptStdOutBtn_${t.ScriptId}`);s&&s.classList.remove("d-none");var l=document.querySelector(`#stdOutContent_${t.ScriptId}`);l&&(l.innerHTML=t.LastRun.STDOUT)}if(""!==t.LastRun.STDERR){var d=document.querySelector(`#ScriptStdErrBtn_${t.ScriptId}`);d&&d.classList.remove("d-none");var c=document.querySelector(`#stdErrContent_${t.ScriptId}`);c&&(c.innerHTML=t.LastRun.STDERR)}makeScriptModalWide()}}}}function generateCallbacksString(e){var t=Vmbox_Scripts[e];if(t){var a=t.LastRun;if(a){var n="server";window.vmbox&&(n=window.vmbox.Hostname);var i=`Script Started at ${UnixToDateString(a.StartTime)}\n`;return a&&a.Callbacks&&a.Callbacks.length&&a.Callbacks.forEach(e=>{i+=`root@${n}:/# ${e.Type} ${""!==e.Content?`(${e.Content})`:""}\n`}),t.LastRun.detailsContent=i,i}}}function makeScriptModalWide(){var e=document.querySelector("#scriptModal");if(e){var t=e.querySelector("#modalPaper");t&&t.classList.add("full-width")}}